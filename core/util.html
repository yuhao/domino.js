<script>

din.exportTo("util", function(){
  // TODO: Better way of differentiating between is and has? This implementation
  // doesn't do that. A correct but inefficient way is to create a global table
  // recording each proxy object created.
  // https://github.com/yuhao/domino.js/issues/10
  function isOrHasProxy(obj) {
    if (obj === null)
      return false;

    return obj.hasOwnProperty("_proxy") || obj.hasOwnProperty("_src");
  }

  function findPropOwner(obj, prop) {
    var currentObj = obj;
    var owner = null;

    while (true) {
      if (currentObj.hasOwnProperty(prop)) {
        owner = currentObj;
        break;
      } else {
        currentObj = currentObj.__proto__;
        if (currentObj === null)
          break;
      }
    }

    return owner;
  }

  function predLog() {
    if (arguments[0]) {
	  // arguments is not an Array so first convert it and then removes the
	  // predicate. Also console.log expect |this| to be console itself.
      var args = Array.from(arguments);
      console.log.apply(console, args.slice(1, args.length));
    }
  }

  function countDOMNodes(obj) {
    var num = 0;

    if (obj.children) {
      var len = obj.children.length;
      num = len;

      for (var i = 0; i < len; i++) {
        var child = obj.children[i];
        num += countDOMNodes(child);
      }
    }
    return num;
  }

  function predAdd(cond, log, key, value) {
    if (cond)
      log[key] = value;
  }

  function tryPost(cond, payload) {
    if (cond) {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "http://146.6.28.88:3000/api/operation");
      xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      xhr.send(JSON.stringify(payload));
      xhr.addEventListener("load", function() {
        predLog(true, "Sent");
      });

      var records = Object.keys(payload);
      for (var i = 0; i < records.length; i++) {
        delete payload[records[i]];
      }
    }
  }

  return {
    findPropOwner: findPropOwner,
    isOrHasProxy: isOrHasProxy,
    countDOMNodes: countDOMNodes,
    predLog: predLog,
    predAdd: predAdd,
    tryPost: tryPost
  }
});

</script>
