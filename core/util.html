<script>
'use strict';

din.exportTo("util", function(){
  // TODO: Better way of differentiating between is and has? This implementation
  // doesn't do that. A correct but inefficient way is to create a global table
  // recording each proxy object created.
  // https://github.com/yuhao/ticket.js/issues/10
  function isOrHasProxy(obj) {
    if (obj === null)
      return false;

    return obj.hasOwnProperty("_proxy") || obj.hasOwnProperty("_src");
  }

  function findPropOwner(obj, prop) {
    var currentObj = obj;
    var owner = null;

    while (true) {
      if (currentObj.hasOwnProperty(prop)) {
        owner = currentObj;
        break;
      } else {
        currentObj = currentObj.__proto__;
        if (currentObj === null)
          break;
      }
    }

    return owner;
  }

  function predLog() {
    if (arguments[0]) {
	  // arguments is not an Array so first convert it and then removes the
	  // predicate. Also console.log expect |this| to be console itself.
      var args = Array.from(arguments);
      console.log.apply(console, args.slice(1, args.length));
    }
  }

  function countDOMNodes(obj) {
    var num = 0;

    if (obj.children) {
      var len = obj.children.length;
      num = len;

      for (var i = 0; i < len; i++) {
        var child = obj.children[i];
        num += countDOMNodes(child);
      }
    }
    return num;
  }

  var gid = 0;
  function assignDOMGID(node) {
    if (!node.hasOwnProperty("_gid")) {
      Object.defineProperty(node, "_gid", {
        configurable: false,
        enumerable: false,
        value: gid++,
        writable: false
      });
    }
  }

  function assignInitialGID() {
    var pendingNode = [window.document.children[0]];

    while (pendingNode.length) {
      var node = pendingNode.shift();
      din.util.assignDOMGID(node);

      var numChildren = node.children.length;
      for (var i = 0; i < numChildren; i++) {
        var child = node.children[i];
        pendingNode.push(child);
      }
    }
  }

  return {
    findPropOwner: findPropOwner,
    isOrHasProxy: isOrHasProxy,
    countDOMNodes: countDOMNodes,
    assignDOMGID: assignDOMGID,
    assignInitialGID: assignInitialGID,
    predLog: predLog,
    gid: gid
  }
});
</script>
